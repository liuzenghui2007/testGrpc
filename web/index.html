<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>gRPC-Web Test</title>
</head>
<body>
    <h1>gRPC-Web Client Test</h1>
    <!-- 这里在Vue应用外部，不能使用Vue -->
    <button @click="fetchRandomStrings">Fetch Random Strings-outside Vue</button>
        
    <div id="app">
        <button @click="fetchRandomStrings">Fetch Random Strings</button>
        <!-- 显示总成功数和失败数 -->
        <h2>Total Success: {{ totalSuccess }}</h2>
        <h2>Total Failures: {{ totalFailures }}</h2>

        <!-- 混合显示成功和失败的请求 -->
        <div v-for="item in requests" :key="item.index">
            <span v-if="item.status === 'success'">
                {{ item.index }} : Success - {{ item.str }}
            </span>
            <span v-else="">
                {{ item.index }} : Failed
            </span>
        </div>
    </div>

    <script type="module">
      import { createApp, ref, computed } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
      import { getOne } from './api.js';

      createApp({
        setup() {
          const requests = ref([]);

          const fetchRandomStrings = async () => {
            console.log('fetch')
            const promises = Array.from({ length: 5000 }, (_, index) => 
              getOne()
                .then(result => ({ index, str: result.value, status: 'success' }))
                .catch(() => ({ index, status: 'failed' }))
            );
            const results = await Promise.allSettled(promises);
            
            results.forEach((result) => {
              if (result.status === 'fulfilled') {
                requests.value.push(result.value);
              } else {
                requests.value.push({ index: result.value.index, status: 'failed' });
              }
            });
          };

          // fetchRandomStrings();

          const totalSuccess = computed(() => requests.value.filter(req => req.status === 'success').length);
          const totalFailures = computed(() => requests.value.filter(req => req.status === 'failed').length);

          return {
            requests,
            totalSuccess,
            totalFailures,
            fetchRandomStrings
          }
        }
      }).mount('#app')
    </script>
</body>
</html>